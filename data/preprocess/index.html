<!-- python3 -m http.server 8000 -->
<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IMCEE Dataset Visualizer & Stats</title>
    
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <script src="https://cdn.tailwindcss.com"></script>

    <style>
        .custom-scrollbar::-webkit-scrollbar { width: 6px; height: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background-color: #cbd5e1; border-radius: 20px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background-color: #94a3b8; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
    </style>
</head>
<body class="bg-gray-50 text-slate-800 h-screen overflow-hidden">
    <div id="root" class="h-full"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo } = React;

        const FILES_TO_LOAD = {
            conversations: 'conversations.jsonl',
            pairs: ['pairs_train.jsonl', 'pairs_test.jsonl', 'pairs_dev.jsonl', 'pairs_valid.jsonl']
        };

        // --- Icons ---
        const IconMessage = () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path></svg>;
        const IconChart = () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="18" y1="20" x2="18" y2="10"></line><line x1="12" y1="20" x2="12" y2="4"></line><line x1="6" y1="20" x2="6" y2="14"></line></svg>;
        const IconUpload = () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="17 8 12 3 7 8"></polyline><line x1="12" y1="3" x2="12" y2="15"></line></svg>;
        const IconFilter = () => <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3"></polygon></svg>;
        const IconAlert = () => <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="8" x2="12" y2="12"></line><line x1="12" y1="16" x2="12.01" y2="16"></line></svg>;
        const IconDatabase = () => <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><ellipse cx="12" cy="5" rx="9" ry="3"></ellipse><path d="M21 12c0 1.66-4 3-9 3s-9-1.34-9-3"></path><path d="M3 5v14c0 1.66 4 3 9 3s 9-1.34 9-3V5"></path></svg>;

        // --- Components ---
        const EmotionBadge = ({ emotion }) => {
            const colors = {
                happiness: 'bg-yellow-100 text-yellow-800 border-yellow-200',
                happy: 'bg-yellow-100 text-yellow-800 border-yellow-200',
                neutral: 'bg-gray-100 text-gray-600 border-gray-200',
                anger: 'bg-red-100 text-red-800 border-red-200',
                angry: 'bg-red-100 text-red-800 border-red-200',
                sadness: 'bg-blue-100 text-blue-800 border-blue-200',
                sad: 'bg-blue-100 text-blue-800 border-blue-200',
                surprise: 'bg-purple-100 text-purple-800 border-purple-200',
                fear: 'bg-indigo-100 text-indigo-800 border-indigo-200',
                disgust: 'bg-green-100 text-green-800 border-green-200',
            };
            const style = colors[emotion?.toLowerCase()] || 'bg-gray-100 text-gray-800 border-gray-200';
            return <span className={`text-[10px] px-2 py-0.5 rounded-full border ${style} capitalize`}>{emotion}</span>;
        };

        const StatCard = ({ title, data, totalPairs }) => {
            const posRatio = data.pairs > 0 ? ((data.pos / data.pairs) * 100).toFixed(1) : 0;
            return (
                <div className="bg-white rounded-xl shadow-sm border p-5 flex-1 min-w-[280px]">
                    <div className="flex justify-between items-start mb-4">
                        <h3 className="text-lg font-bold text-slate-700 capitalize">{title}</h3>
                        <span className="text-xs bg-slate-100 text-slate-500 px-2 py-1 rounded font-mono">
                            {data.pairs.toLocaleString()} pairs
                        </span>
                    </div>
                    
                    <div className="grid grid-cols-2 gap-4 mb-4">
                        <div className="bg-blue-50 p-3 rounded-lg border border-blue-100">
                            <div className="text-xs text-blue-500 font-semibold uppercase mb-1">Conversations</div>
                            <div className="text-2xl font-bold text-blue-700">{data.convs.toLocaleString()}</div>
                        </div>
                        <div className="bg-indigo-50 p-3 rounded-lg border border-indigo-100">
                            <div className="text-xs text-indigo-500 font-semibold uppercase mb-1">Utterances</div>
                            <div className="text-2xl font-bold text-indigo-700">{data.utts.toLocaleString()}</div>
                        </div>
                    </div>

                    <div className="space-y-3">
                        <div>
                            <div className="flex justify-between text-xs mb-1">
                                <span className="font-semibold text-green-600">Positive (Cause)</span>
                                <span className="text-green-700">{data.pos.toLocaleString()} ({posRatio}%)</span>
                            </div>
                            <div className="w-full bg-gray-100 rounded-full h-2">
                                <div className="bg-green-500 h-2 rounded-full" style={{ width: `${posRatio}%` }}></div>
                            </div>
                        </div>
                        <div>
                            <div className="flex justify-between text-xs mb-1">
                                <span className="font-semibold text-gray-500">Negative</span>
                                <span className="text-gray-600">{data.neg.toLocaleString()}</span>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        // --- Main App ---
        function App() {
            const [conversations, setConversations] = useState([]);
            const [pairs, setPairs] = useState([]);
            const [selectedConvId, setSelectedConvId] = useState(null);
            const [selectedSplit, setSelectedSplit] = useState('all');
            const [activeTargetId, setActiveTargetId] = useState(null);
            const [loading, setLoading] = useState(true);
            const [error, setError] = useState(null);
            const [currentView, setCurrentView] = useState('visualizer'); // 'visualizer' | 'stats'

            const parseJsonl = (content) => {
                const lines = content.split('\n');
                const result = [];
                for (const line of lines) {
                    if (line.trim()) {
                        try { result.push(JSON.parse(line)); } catch (e) { console.error(e); }
                    }
                }
                return result;
            };

            // Load Data
            useEffect(() => {
                const loadLocalFiles = async () => {
                    setLoading(true);
                    setError(null);
                    const allPairs = [];

                    try {
                        // 1. Load Conversations
                        const convRes = await fetch(FILES_TO_LOAD.conversations);
                        if (convRes.ok) {
                            const text = await convRes.text();
                            const data = parseJsonl(text);
                            if (data.length > 0) {
                                setConversations(data);
                                setSelectedConvId(data[0].conv_id);
                            }
                        } else {
                            throw new Error("Local fetch failed");
                        }

                        // 2. Load Pairs
                        await Promise.all(FILES_TO_LOAD.pairs.map(async (filename) => {
                            try {
                                const res = await fetch(filename);
                                if (res.ok) {
                                    const text = await res.text();
                                    const data = parseJsonl(text);
                                    allPairs.push(...data);
                                }
                            } catch (err) { }
                        }));
                        setPairs(allPairs);

                    } catch (err) {
                        console.log("Auto-load failed", err);
                        setError("無法自動讀取檔案。請使用右上角按鈕手動上傳。");
                    } finally {
                        setLoading(false);
                    }
                };
                loadLocalFiles();
            }, []);

            const handleFileUpload = (e, type) => {
                const file = e.target.files?.[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (event) => {
                    const data = parseJsonl(event.target.result);
                    if (type === 'conv') {
                        setConversations(data);
                        if (data.length > 0 && !selectedConvId) setSelectedConvId(data[0].conv_id);
                        setError(null);
                    } else {
                        setPairs(prev => [...prev, ...data]);
                    }
                };
                reader.readAsText(file);
            };

            // Process Data: Combine Conv + Pairs + Splits
            const processedData = useMemo(() => {
                const data = {};
                conversations.forEach(conv => {
                    data[conv.conv_id] = { ...conv, split: 'unknown', pairs: [] };
                });
                pairs.forEach(pair => {
                    if (data[pair.conv_id]) {
                        if (pair.meta && pair.meta.split) data[pair.conv_id].split = pair.meta.split;
                        data[pair.conv_id].pairs.push(pair);
                    }
                });
                return data;
            }, [conversations, pairs]);

            const conversationList = Object.values(processedData);

            // Statistics Calculation
            const stats = useMemo(() => {
                const result = {}; // { 'train': { convs, utts, pairs, pos, neg }, ... }
                
                // Init global total
                result['total'] = { convs: 0, utts: 0, pairs: 0, pos: 0, neg: 0 };

                conversationList.forEach(conv => {
                    const split = conv.split || 'unknown';
                    if (!result[split]) result[split] = { convs: 0, utts: 0, pairs: 0, pos: 0, neg: 0 };

                    // Conv & Utts
                    result[split].convs += 1;
                    result[split].utts += conv.utterances.length;
                    result['total'].convs += 1;
                    result['total'].utts += conv.utterances.length;

                    // Pairs
                    const convPairs = conv.pairs || [];
                    const count = convPairs.length;
                    const posCount = convPairs.filter(p => p.label === 1).length;
                    const negCount = count - posCount;

                    result[split].pairs += count;
                    result[split].pos += posCount;
                    result[split].neg += negCount;

                    result['total'].pairs += count;
                    result['total'].pos += posCount;
                    result['total'].neg += negCount;
                });

                return result;
            }, [conversationList]);

            // Visualizer Logic
            const splits = useMemo(() => {
                const s = new Set(conversationList.map(c => c.split));
                s.delete('unknown');
                const list = ['all', ...Array.from(s)];
                if (conversationList.some(c => c.split === 'unknown')) list.push('unknown');
                return list;
            }, [conversationList]);

            const filteredList = conversationList.filter(c => selectedSplit === 'all' || c.split === selectedSplit);
            const activeConv = selectedConvId ? processedData[selectedConvId] : null;

            const validCauses = useMemo(() => {
                if (!activeConv || !activeTargetId) return new Set();
                return new Set(activeConv.pairs.filter(p => p.t_utt_id === activeTargetId && p.label === 1).map(p => p.c_utt_id));
            }, [activeConv, activeTargetId]);

            const availableTargets = useMemo(() => {
                if (!activeConv) return new Set();
                return new Set(activeConv.pairs.filter(p => p.label === 1).map(p => p.t_utt_id));
            }, [activeConv]);

            return (
                <div className="flex flex-col h-full">
                    {/* Header */}
                    <header className="bg-white border-b px-6 py-4 flex justify-between items-center shadow-sm flex-shrink-0 z-20">
                        <div className="flex items-center gap-6">
                            <div className="flex items-center gap-3">
                                <div className="bg-slate-800 p-2 rounded text-white shadow-lg shadow-slate-200">
                                    {currentView === 'visualizer' ? <IconMessage /> : <IconChart />}
                                </div>
                                <div>
                                    <h1 className="text-xl font-bold text-gray-800">IMCEE Dataset</h1>
                                    <div className="text-xs text-gray-500">Casual Emotion Entailment</div>
                                </div>
                            </div>

                            {/* View Switcher Tabs */}
                            <div className="flex bg-gray-100 p-1 rounded-lg">
                                <button 
                                    onClick={() => setCurrentView('visualizer')}
                                    className={`px-4 py-1.5 text-sm font-semibold rounded-md transition-all ${currentView === 'visualizer' ? 'bg-white text-blue-600 shadow-sm' : 'text-gray-500 hover:text-gray-700'}`}>
                                    Visualizer
                                </button>
                                <button 
                                    onClick={() => setCurrentView('stats')}
                                    className={`px-4 py-1.5 text-sm font-semibold rounded-md transition-all ${currentView === 'stats' ? 'bg-white text-blue-600 shadow-sm' : 'text-gray-500 hover:text-gray-700'}`}>
                                    Statistics
                                </button>
                            </div>
                        </div>

                        <div className="flex gap-2">
                             <label className="flex items-center gap-2 cursor-pointer bg-white border hover:bg-gray-50 px-3 py-1.5 rounded text-sm text-gray-600 transition-colors">
                                <IconUpload /> <span>Conv (.jsonl)</span>
                                <input type="file" className="hidden" onChange={(e) => handleFileUpload(e, 'conv')} />
                            </label>
                            <label className="flex items-center gap-2 cursor-pointer bg-white border hover:bg-gray-50 px-3 py-1.5 rounded text-sm text-gray-600 transition-colors">
                                <IconUpload /> <span>Pairs (.jsonl)</span>
                                <input type="file" className="hidden" onChange={(e) => handleFileUpload(e, 'pairs')} />
                            </label>
                        </div>
                    </header>

                    {/* Content Area */}
                    <div className="flex flex-1 overflow-hidden">
                        
                        {/* VIEW: STATISTICS */}
                        {currentView === 'stats' && (
                            <div className="flex-1 overflow-y-auto bg-slate-50 p-8 custom-scrollbar">
                                <div className="max-w-6xl mx-auto">
                                    <h2 className="text-2xl font-bold text-slate-800 mb-6">Dataset Statistics</h2>
                                    
                                    {/* Total Summary */}
                                    <div className="mb-8">
                                        <StatCard title="Total Dataset" data={stats['total']} />
                                    </div>

                                    <h3 className="text-lg font-bold text-slate-600 mb-4 px-1">Splits Breakdown</h3>
                                    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 pb-20">
                                        {Object.keys(stats).filter(k => k !== 'total').sort().map(split => (
                                            <StatCard key={split} title={split} data={stats[split]} />
                                        ))}
                                    </div>
                                    
                                    {Object.keys(stats).length <= 1 && !loading && (
                                        <div className="text-center py-10 bg-white rounded-xl border border-dashed border-gray-300 text-gray-400">
                                            No split information found. Please upload pairs_train/test/dev.jsonl files.
                                        </div>
                                    )}
                                </div>
                            </div>
                        )}

                        {/* VIEW: VISUALIZER */}
                        {currentView === 'visualizer' && (
                            <>
                                {/* Sidebar */}
                                <aside className="w-80 bg-white border-r flex flex-col z-10 shadow-[4px_0_24px_rgba(0,0,0,0.02)]">
                                    <div className="p-4 border-b bg-gray-50/50">
                                        <div className="flex items-center gap-2 text-gray-400 mb-2">
                                            <IconFilter /> <span className="text-[10px] font-bold uppercase">Split</span>
                                        </div>
                                        <div className="flex flex-wrap gap-1">
                                            {splits.map(split => (
                                                <button key={split} onClick={() => setSelectedSplit(split)}
                                                    className={`px-3 py-1 text-xs rounded-full border capitalize transition-colors ${selectedSplit === split ? 'bg-slate-800 text-white border-slate-800' : 'bg-white text-gray-600 hover:bg-gray-100'}`}>
                                                    {split}
                                                </button>
                                            ))}
                                        </div>
                                    </div>
                                    
                                    <div className="flex-1 overflow-y-auto custom-scrollbar">
                                        {loading ? <div className="p-4 text-center text-sm text-gray-400 animate-pulse">Loading data...</div> :
                                         filteredList.length === 0 ? 
                                            <div className="p-8 text-center text-gray-400 text-sm">{error || "No data loaded."}</div> :
                                            filteredList.map(conv => (
                                            <div key={conv.conv_id} onClick={() => { setSelectedConvId(conv.conv_id); setActiveTargetId(null); }}
                                                className={`px-4 py-3 border-b cursor-pointer transition-colors hover:bg-blue-50/50 ${selectedConvId === conv.conv_id ? 'bg-blue-50 border-l-4 border-l-blue-500' : 'border-l-4 border-l-transparent'}`}>
                                                <div className="flex justify-between mb-1">
                                                    <span className={`font-bold text-xs ${selectedConvId === conv.conv_id ? 'text-blue-700' : 'text-slate-700'}`}>{conv.conv_id}</span>
                                                    <span className={`text-[9px] px-1.5 rounded font-bold uppercase border ${conv.split === 'test' ? 'bg-purple-50 text-purple-600 border-purple-100' : conv.split === 'train' ? 'bg-emerald-50 text-emerald-600 border-emerald-100' : 'bg-gray-50 text-gray-500 border-gray-100'}`}>{conv.split}</span>
                                                </div>
                                                <div className="text-xs text-gray-500 truncate">{conv.utterances[0]?.text}</div>
                                                {conv.pairs.length > 0 && 
                                                    <div className="mt-1 flex items-center gap-1 text-[10px] text-blue-500 font-medium"><IconDatabase /> {conv.pairs.filter(p => p.label === 1).length} causes</div>
                                                }
                                            </div>
                                        ))}
                                    </div>
                                </aside>

                                {/* Main Chat */}
                                <main className="flex-1 bg-slate-100/50 flex flex-col relative">
                                    {!activeConv ? <div className="flex-1 flex items-center justify-center text-gray-400 text-sm">Select a conversation to view details</div> :
                                    <div className="flex-1 overflow-y-auto p-4 md:p-8 custom-scrollbar">
                                        <div className="max-w-3xl mx-auto space-y-6 pb-20">
                                            <div className="flex justify-between items-center sticky top-0 bg-slate-100/90 py-3 backdrop-blur z-10 border-b border-gray-200/50 mb-6">
                                                <span className="text-xs font-mono text-gray-500 bg-gray-200/50 px-2 py-1 rounded">ID: {activeConv.conv_id}</span>
                                                {availableTargets.size > 0 && <span className="text-xs font-bold text-blue-600 bg-blue-50 px-3 py-1 rounded-full border border-blue-100 flex items-center gap-1 animate-pulse"><IconAlert/> Click on TARGET to highlight causes</span>}
                                            </div>

                                            {activeConv.utterances.map(utt => {
                                                const isUserA = utt.speaker.trim() === 'A';
                                                const isTarget = availableTargets.has(utt.utt_id);
                                                const isCause = validCauses.has(utt.utt_id);
                                                const isActive = activeTargetId === utt.utt_id;

                                                return (
                                                    <div key={utt.utt_id} className={`flex gap-4 ${isUserA ? 'flex-row' : 'flex-row-reverse'}`}>
                                                        <div className={`w-8 h-8 rounded-full flex-shrink-0 flex items-center justify-center text-xs font-bold text-white shadow-sm ring-2 ring-white ${isUserA ? 'bg-blue-500' : 'bg-slate-700'}`}>{utt.speaker}</div>
                                                        <div className="max-w-[85%] relative group">
                                                            <div onClick={() => isTarget && setActiveTargetId(isActive ? null : utt.utt_id)}
                                                                className={`p-4 rounded-2xl shadow-sm border transition-all cursor-default relative overflow-hidden
                                                                ${isActive ? 'ring-2 ring-red-400 ring-offset-2 scale-[1.01]' : ''}
                                                                ${isCause ? 'ring-2 ring-green-500 bg-green-50 border-green-200' : ''}
                                                                ${isUserA && !isCause ? 'bg-white rounded-tl-none' : ''}
                                                                ${!isUserA && !isCause ? 'bg-blue-50 border-blue-100 rounded-tr-none' : ''}
                                                                ${isTarget ? 'hover:shadow-md cursor-pointer hover:border-red-200' : ''}`}>
                                                                
                                                                <div className="flex justify-between items-start gap-3 mb-2">
                                                                    <span className="text-[10px] font-mono text-gray-300">#{utt.utt_id}</span>
                                                                    <div className="flex gap-1">
                                                                        {isTarget && <span className={`flex items-center gap-1 text-[9px] font-bold px-1.5 py-0.5 rounded uppercase tracking-wider ${isActive ? 'bg-red-500 text-white' : 'text-red-500 bg-red-50 border border-red-100'}`}>Target</span>}
                                                                        {isCause && <span className="flex items-center gap-1 text-[9px] font-bold text-green-700 bg-green-100 border border-green-200 px-1.5 py-0.5 rounded uppercase tracking-wider">Cause</span>}
                                                                    </div>
                                                                </div>
                                                                <p className={`text-sm leading-relaxed whitespace-pre-wrap ${isCause ? 'text-green-900 font-medium' : 'text-slate-700'}`}>{utt.text}</p>
                                                                <div className="flex justify-end mt-3 opacity-90"><EmotionBadge emotion={utt.emotion} /></div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                );
                                            })}
                                        </div>
                                    </div>
                                    }
                                </main>
                            </>
                        )}
                    </div>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>