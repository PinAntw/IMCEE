<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IMCEE Dataset Visualizer</title>
    
    <!-- React & ReactDOM (Development Version for better error messages) python -m http.server 8023 -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    
    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <style>
        /* Custom Scrollbar */
        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background-color: #cbd5e1; border-radius: 20px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background-color: #94a3b8; }
        
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
    </style>
</head>
<body class="bg-gray-50 text-slate-800 h-screen overflow-hidden">
    <div id="root" class="h-full"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo } = React;

        // --- 設定區 ---
        const FILES_TO_LOAD = {
            conversations: 'conversations.jsonl',
            pairs: ['pairs_train.jsonl', 'pairs_test.jsonl', 'pairs_dev.jsonl', 'pairs_valid.jsonl']
        };

        // --- Icons (SVG Components to avoid dependencies) ---
        const IconMessage = () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path></svg>;
        const IconUpload = () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="17 8 12 3 7 8"></polyline><line x1="12" y1="3" x2="12" y2="15"></line></svg>;
        const IconFilter = () => <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3"></polygon></svg>;
        const IconCheck = () => <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="3" strokeLinecap="round" strokeLinejoin="round"><polyline points="20 6 9 17 4 12"></polyline></svg>;
        const IconAlert = () => <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="8" x2="12" y2="12"></line><line x1="12" y1="16" x2="12.01" y2="16"></line></svg>;
        const IconDatabase = () => <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><ellipse cx="12" cy="5" rx="9" ry="3"></ellipse><path d="M21 12c0 1.66-4 3-9 3s-9-1.34-9-3"></path><path d="M3 5v14c0 1.66 4 3 9 3s 9-1.34 9-3V5"></path></svg>;

        // --- Helper: Emotion Badge ---
        const EmotionBadge = ({ emotion }) => {
            const colors = {
                happiness: 'bg-yellow-100 text-yellow-800 border-yellow-200',
                happy: 'bg-yellow-100 text-yellow-800 border-yellow-200',
                neutral: 'bg-gray-100 text-gray-600 border-gray-200',
                anger: 'bg-red-100 text-red-800 border-red-200',
                angry: 'bg-red-100 text-red-800 border-red-200',
                sadness: 'bg-blue-100 text-blue-800 border-blue-200',
                sad: 'bg-blue-100 text-blue-800 border-blue-200',
                surprise: 'bg-purple-100 text-purple-800 border-purple-200',
                fear: 'bg-indigo-100 text-indigo-800 border-indigo-200',
                disgust: 'bg-green-100 text-green-800 border-green-200',
            };
            const style = colors[emotion?.toLowerCase()] || 'bg-gray-100 text-gray-800 border-gray-200';
            return (
                <span className={`text-[10px] px-2 py-0.5 rounded-full border ${style} capitalize`}>
                    {emotion}
                </span>
            );
        };

        // --- Main Component ---
        function App() {
            const [conversations, setConversations] = useState([]);
            const [pairs, setPairs] = useState([]);
            const [selectedConvId, setSelectedConvId] = useState(null);
            const [selectedSplit, setSelectedSplit] = useState('all');
            const [activeTargetId, setActiveTargetId] = useState(null);
            const [loading, setLoading] = useState(true);
            const [loadedFiles, setLoadedFiles] = useState([]);
            const [error, setError] = useState(null);

            const parseJsonl = (content) => {
                const lines = content.split('\n');
                const result = [];
                for (const line of lines) {
                    if (line.trim()) {
                        try { result.push(JSON.parse(line)); } catch (e) { console.error(e); }
                    }
                }
                return result;
            };

            useEffect(() => {
                const loadLocalFiles = async () => {
                    setLoading(true);
                    setError(null);
                    const successfulFiles = [];
                    const allPairs = [];

                    try {
                        // Attempt to fetch conversations
                        const convRes = await fetch(FILES_TO_LOAD.conversations);
                        if (convRes.ok) {
                            const text = await convRes.text();
                            const data = parseJsonl(text);
                            if (data.length > 0) {
                                setConversations(data);
                                setSelectedConvId(data[0].conv_id);
                                successfulFiles.push(FILES_TO_LOAD.conversations);
                            }
                        } else {
                            // If running via file:// protocol or file missing
                            throw new Error("Local fetch failed");
                        }

                        // Attempt to fetch pairs
                        await Promise.all(FILES_TO_LOAD.pairs.map(async (filename) => {
                            try {
                                const res = await fetch(filename);
                                if (res.ok) {
                                    const text = await res.text();
                                    const data = parseJsonl(text);
                                    allPairs.push(...data);
                                    successfulFiles.push(filename);
                                }
                            } catch (err) { /* ignore */ }
                        }));

                        setPairs(allPairs);
                        setLoadedFiles(successfulFiles);
                    } catch (err) {
                        console.log("Auto-load failed (normal if not running on server)", err);
                        setError("無法自動讀取檔案（可能是因為您直接開啟了 HTML 檔案，或是檔案不存在）。請使用下方的「Upload」按鈕手動選取檔案。");
                    } finally {
                        setLoading(false);
                    }
                };
                loadLocalFiles();
            }, []);

            const handleFileUpload = (e, type) => {
                const file = e.target.files?.[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (event) => {
                    const data = parseJsonl(event.target.result);
                    if (type === 'conv') {
                        setConversations(data);
                        if (data.length > 0 && !selectedConvId) setSelectedConvId(data[0].conv_id);
                        setError(null);
                    } else {
                        setPairs(prev => [...prev, ...data]);
                    }
                };
                reader.readAsText(file);
            };

            // Process Data
            const processedData = useMemo(() => {
                const data = {};
                conversations.forEach(conv => {
                    data[conv.conv_id] = { ...conv, split: 'unknown', pairs: [] };
                });
                pairs.forEach(pair => {
                    if (data[pair.conv_id]) {
                        if (pair.meta && pair.meta.split) data[pair.conv_id].split = pair.meta.split;
                        data[pair.conv_id].pairs.push(pair);
                    }
                });
                return data;
            }, [conversations, pairs]);

            const conversationList = Object.values(processedData);
            
            const splits = useMemo(() => {
                const s = new Set(conversationList.map(c => c.split));
                s.delete('unknown');
                const list = ['all', ...Array.from(s)];
                if (conversationList.some(c => c.split === 'unknown')) list.push('unknown');
                return list;
            }, [conversationList]);

            const filteredList = conversationList.filter(c => selectedSplit === 'all' || c.split === selectedSplit);
            const activeConv = selectedConvId ? processedData[selectedConvId] : null;

            const validCauses = useMemo(() => {
                if (!activeConv || !activeTargetId) return new Set();
                return new Set(activeConv.pairs.filter(p => p.t_utt_id === activeTargetId && p.label === 1).map(p => p.c_utt_id));
            }, [activeConv, activeTargetId]);

            const availableTargets = useMemo(() => {
                if (!activeConv) return new Set();
                return new Set(activeConv.pairs.filter(p => p.label === 1).map(p => p.t_utt_id));
            }, [activeConv]);

            return (
                <div className="flex flex-col h-full">
                    {/* Header */}
                    <header className="bg-white border-b px-6 py-4 flex justify-between items-center shadow-sm flex-shrink-0">
                        <div className="flex items-center gap-3">
                            <div className="bg-blue-600 p-2 rounded text-white"><IconMessage /></div>
                            <div>
                                <h1 className="text-xl font-bold text-gray-800">IMCEE Visualizer</h1>
                                <div className="text-xs text-gray-500">
                                    {conversations.length} convs, {pairs.length} pairs loaded
                                </div>
                            </div>
                        </div>
                        <div className="flex gap-2">
                             <label className="flex items-center gap-2 cursor-pointer bg-white border hover:bg-gray-50 px-3 py-1.5 rounded text-sm text-gray-600">
                                <IconUpload /> <span>Conv (.jsonl)</span>
                                <input type="file" className="hidden" onChange={(e) => handleFileUpload(e, 'conv')} />
                            </label>
                            <label className="flex items-center gap-2 cursor-pointer bg-white border hover:bg-gray-50 px-3 py-1.5 rounded text-sm text-gray-600">
                                <IconUpload /> <span>Pairs (.jsonl)</span>
                                <input type="file" className="hidden" onChange={(e) => handleFileUpload(e, 'pairs')} />
                            </label>
                        </div>
                    </header>

                    {/* Body */}
                    <div className="flex flex-1 overflow-hidden">
                        {/* Sidebar */}
                        <aside className="w-80 bg-white border-r flex flex-col z-10 shadow-[4px_0_24px_rgba(0,0,0,0.02)]">
                            <div className="p-4 border-b bg-gray-50/50">
                                <div className="flex items-center gap-2 text-gray-400 mb-2">
                                    <IconFilter /> <span className="text-[10px] font-bold uppercase">Split</span>
                                </div>
                                <div className="flex flex-wrap gap-1">
                                    {splits.map(split => (
                                        <button key={split} onClick={() => setSelectedSplit(split)}
                                            className={`px-3 py-1 text-xs rounded-full border capitalize ${selectedSplit === split ? 'bg-slate-800 text-white' : 'bg-white text-gray-600'}`}>
                                            {split}
                                        </button>
                                    ))}
                                </div>
                            </div>
                            
                            <div className="flex-1 overflow-y-auto custom-scrollbar">
                                {loading ? <div className="p-4 text-center text-sm text-gray-400">Loading...</div> :
                                 filteredList.length === 0 ? 
                                    <div className="p-8 text-center text-gray-400 text-sm">{error || "No data"}</div> :
                                    filteredList.map(conv => (
                                    <div key={conv.conv_id} onClick={() => { setSelectedConvId(conv.conv_id); setActiveTargetId(null); }}
                                        className={`px-4 py-3 border-b cursor-pointer hover:bg-blue-50/50 ${selectedConvId === conv.conv_id ? 'bg-blue-50 border-l-4 border-l-blue-500' : 'border-l-4 border-l-transparent'}`}>
                                        <div className="flex justify-between mb-1">
                                            <span className={`font-bold text-xs ${selectedConvId === conv.conv_id ? 'text-blue-700' : 'text-slate-700'}`}>{conv.conv_id}</span>
                                            <span className={`text-[9px] px-1.5 rounded font-bold uppercase ${conv.split === 'test' ? 'bg-purple-100 text-purple-600' : conv.split === 'train' ? 'bg-emerald-100 text-emerald-600' : 'bg-gray-100'}`}>{conv.split}</span>
                                        </div>
                                        <div className="text-xs text-gray-500 truncate">{conv.utterances[0]?.text}</div>
                                        {conv.pairs.filter(p => p.label === 1).length > 0 && 
                                            <div className="mt-1 flex items-center gap-1 text-[10px] text-blue-500"><IconDatabase /> {conv.pairs.filter(p => p.label === 1).length} pairs</div>
                                        }
                                    </div>
                                ))}
                            </div>
                        </aside>

                        {/* Main Chat */}
                        <main className="flex-1 bg-slate-100/50 flex flex-col">
                            {!activeConv ? <div className="flex-1 flex items-center justify-center text-gray-400 text-sm">Select a conversation</div> :
                            <div className="flex-1 overflow-y-auto p-4 md:p-8 custom-scrollbar">
                                <div className="max-w-3xl mx-auto space-y-6 pb-20">
                                    <div className="flex justify-between items-center sticky top-0 bg-slate-100/90 py-2 backdrop-blur z-20 border-b border-gray-200/50">
                                        <span className="text-xs text-gray-500">ID: {activeConv.conv_id}</span>
                                        {availableTargets.size > 0 && <span className="text-xs font-bold text-red-500 flex items-center gap-1 animate-pulse"><IconAlert/> Click TARGETs to see causes</span>}
                                    </div>

                                    {activeConv.utterances.map(utt => {
                                        const isUserA = utt.speaker.trim() === 'A';
                                        const isTarget = availableTargets.has(utt.utt_id);
                                        const isCause = validCauses.has(utt.utt_id);
                                        const isActive = activeTargetId === utt.utt_id;

                                        return (
                                            <div key={utt.utt_id} className={`flex gap-3 ${isUserA ? 'flex-row' : 'flex-row-reverse'}`}>
                                                <div className={`w-8 h-8 rounded-full flex items-center justify-center text-xs font-bold text-white shadow-sm ${isUserA ? 'bg-blue-500' : 'bg-slate-700'}`}>{utt.speaker}</div>
                                                <div className="max-w-[80%] relative group">
                                                    <div onClick={() => isTarget && setActiveTargetId(isActive ? null : utt.utt_id)}
                                                        className={`p-3 rounded-2xl shadow-sm border transition-all cursor-default 
                                                        ${isActive ? 'ring-2 ring-red-400 scale-[1.01]' : ''}
                                                        ${isCause ? 'ring-2 ring-green-500 bg-green-50 border-green-200' : ''}
                                                        ${isUserA && !isCause ? 'bg-white rounded-tl-sm' : ''}
                                                        ${!isUserA && !isCause ? 'bg-blue-50 rounded-tr-sm' : ''}
                                                        ${isTarget ? 'hover:shadow-md cursor-pointer' : ''}`}>
                                                        
                                                        <div className="flex justify-between gap-3 mb-1">
                                                            <span className="text-[10px] text-gray-300">#{utt.utt_id}</span>
                                                            <div className="flex gap-1">
                                                                {isTarget && <span className={`flex items-center gap-1 text-[9px] font-bold px-1 rounded uppercase ${isActive ? 'bg-red-500 text-white' : 'text-red-500 bg-red-50'}`}>TARGET</span>}
                                                                {isCause && <span className="flex items-center gap-1 text-[9px] font-bold text-green-700 bg-green-100 px-1 rounded uppercase">CAUSE</span>}
                                                            </div>
                                                        </div>
                                                        <p className={`text-sm whitespace-pre-wrap ${isCause ? 'text-green-900 font-medium' : 'text-slate-700'}`}>{utt.text}</p>
                                                        <div className="flex justify-end mt-2 opacity-80"><EmotionBadge emotion={utt.emotion} /></div>
                                                    </div>
                                                </div>
                                            </div>
                                        );
                                    })}
                                </div>
                            </div>
                            }
                        </main>
                    </div>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>